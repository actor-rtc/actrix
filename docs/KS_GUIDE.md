# KS (Key Server) å®Œå…¨æŒ‡å—

**ç‰ˆæœ¬**: v0.1.0
**æœ€åæ›´æ–°**: 2025-11-03
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª (å†…éƒ¨ä½¿ç”¨)

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
3. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
4. [å·¥ä½œæµç¨‹](#å·¥ä½œæµç¨‹)
5. [API è¯¦è§£](#api-è¯¦è§£)
6. [å®‰å…¨æœºåˆ¶](#å®‰å…¨æœºåˆ¶)
7. [æ•°æ®å­˜å‚¨](#æ•°æ®å­˜å‚¨)
8. [å®¢æˆ·ç«¯é›†æˆ](#å®¢æˆ·ç«¯é›†æˆ)
9. [è¿ç»´æŒ‡å—](#è¿ç»´æŒ‡å—)
10. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ KS?

**KS (Key Server)** æ˜¯ Actrix é¡¹ç›®ä¸­çš„**æ¤­åœ†æ›²çº¿å¯†é’¥ç®¡ç†æœåŠ¡**ï¼Œä¸ºæ•´ä¸ª Actor-RTC ç”Ÿæ€ç³»ç»Ÿæä¾›åŠ å¯†å¯†é’¥çš„ç”Ÿæˆã€å­˜å‚¨å’ŒæŸ¥è¯¢èƒ½åŠ›ã€‚

### æ ¸å¿ƒåŠŸèƒ½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    KS æ ¸å¿ƒåŠŸèƒ½                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ğŸ”‘ å¯†é’¥ç”Ÿæˆ     â†’ ç”Ÿæˆ ECIES æ¤­åœ†æ›²çº¿å¯†é’¥å¯¹           â”‚
â”‚  ğŸ’¾ å®‰å…¨å­˜å‚¨     â†’ SQLite æŒä¹…åŒ–å­˜å‚¨                   â”‚
â”‚  ğŸ” å¯†é’¥æŸ¥è¯¢     â†’ åŸºäº key_id å¿«é€Ÿæ£€ç´¢                â”‚
â”‚  â° ç”Ÿå‘½å‘¨æœŸç®¡ç†  â†’ è‡ªåŠ¨è¿‡æœŸå’Œæ¸…ç†                      â”‚
â”‚  ğŸ›¡ï¸  é˜²é‡æ”¾æ”»å‡»   â†’ Nonce + PSK åŒé‡ä¿æŠ¤               â”‚
â”‚  ğŸ“Š çŠ¶æ€ç›‘æ§     â†’ å¥åº·æ£€æŸ¥å’Œç»Ÿè®¡ä¿¡æ¯                   â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä½¿ç”¨åœºæ™¯

```
åœºæ™¯ 1: AIS æœåŠ¡éœ€è¦åŠ å¯† Actor ID Token
   â”œâ”€> AIS å‘ KS è¯·æ±‚å…¬é’¥
   â”œâ”€> KS ç”Ÿæˆå¯†é’¥å¯¹ï¼Œè¿”å›å…¬é’¥
   â”œâ”€> AIS ä½¿ç”¨å…¬é’¥åŠ å¯† Token
   â””â”€> éªŒè¯æœåŠ¡ä» KS è·å–ç§é’¥è§£å¯†

åœºæ™¯ 2: å†…éƒ¨æœåŠ¡é—´åŠ å¯†é€šä¿¡
   â”œâ”€> æœåŠ¡ A ä» KS è·å–å…¬é’¥
   â”œâ”€> æœåŠ¡ A ä½¿ç”¨å…¬é’¥åŠ å¯†æ•æ„Ÿæ•°æ®
   â”œâ”€> æœåŠ¡ B ä» KS è·å–ç§é’¥è§£å¯†
   â””â”€> å®ç°ç«¯åˆ°ç«¯åŠ å¯†
```

### å…³é”®ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ | æ–‡ä»¶ä½ç½® |
|------|------|---------|
| **ECIES åŠ å¯†** | åŸºäºæ¤­åœ†æ›²çº¿çš„é›†æˆåŠ å¯†æ–¹æ¡ˆ | `storage.rs:196` |
| **è‡ªåŠ¨é€’å¢ ID** | SQLite AUTOINCREMENT é¿å…å†²çª | `storage.rs:61` |
| **PSK è®¤è¯** | Pre-Shared Key è®¤è¯æœºåˆ¶ | `handlers.rs:35-57` |
| **Nonce é˜²é‡æ”¾** | åŸºäº nonce-auth v0.6.1 | `nonce_storage.rs` |
| **å¯†é’¥è¿‡æœŸ** | å¯é…ç½® TTLï¼Œè‡ªåŠ¨æ¸…ç† | `storage.rs:226-244` |
| **RESTful API** | æ ‡å‡† HTTP JSON æ¥å£ | `handlers.rs:86-92` |

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. æ¤­åœ†æ›²çº¿åŠ å¯† (ECIES)

```
ECIES (Elliptic Curve Integrated Encryption Scheme)
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                       â•‘
â•‘  ç§é’¥ (Secret Key)  â†’  32 å­—èŠ‚éšæœºæ•°                 â•‘
â•‘           â†“                                           â•‘
â•‘  å…¬é’¥ (Public Key)  â†’  ä»ç§é’¥æ¨å¯¼ (33 å­—èŠ‚å‹ç¼©æ ¼å¼)  â•‘
â•‘                                                       â•‘
â•‘  ç‰¹ç‚¹:                                                â•‘
â•‘  â€¢ å°å¯†é’¥å°ºå¯¸ (256-bit)                              â•‘
â•‘  â€¢ é«˜å®‰å…¨æ€§ (ç­‰æ•ˆ RSA 3072-bit)                      â•‘
â•‘  â€¢ å¿«é€Ÿè¿ç®—                                          â•‘
â•‘  â€¢ éå¯¹ç§°åŠ å¯†                                        â•‘
â•‘                                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**ä»£ç å®ç°**:
```rust
// æ–‡ä»¶: crates/ks/src/storage.rs:196
let (secret_key, public_key) = ecies::utils::generate_keypair();
```

### 2. å¯†é’¥ ID (key_id)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  key_id çš„ä½œç”¨                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  1. å”¯ä¸€æ ‡è¯†ç¬¦ â†’ æ¯ä¸ªå¯†é’¥å¯¹çš„å”¯ä¸€ ID          â”‚
â”‚  2. è‡ªåŠ¨é€’å¢   â†’ SQLite AUTOINCREMENT          â”‚
â”‚  3. æŸ¥è¯¢ç´¢å¼•   â†’ å¿«é€Ÿæ£€ç´¢å¯†é’¥                  â”‚
â”‚  4. ç‰ˆæœ¬æ§åˆ¶   â†’ æ”¯æŒå¯†é’¥è½®è½¬                  â”‚
â”‚                                                 â”‚
â”‚  ç¤ºä¾‹:                                          â”‚
â”‚  key_id=1  â†’  ç¬¬ä¸€æ¬¡ç”Ÿæˆçš„å¯†é’¥å¯¹               â”‚
â”‚  key_id=2  â†’  ç¬¬äºŒæ¬¡ç”Ÿæˆçš„å¯†é’¥å¯¹               â”‚
â”‚  key_id=N  â†’  ç¬¬ N æ¬¡ç”Ÿæˆçš„å¯†é’¥å¯¹              â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. å¯†é’¥ç”Ÿå‘½å‘¨æœŸ

```
å¯†é’¥ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æœº
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

   åˆ›å»º (Created)
        â”‚
        â”‚ generate_and_store_key()
        â†“
   æ´»è·ƒ (Active)  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚
        â”‚ æ—¶é—´æ¨ç§»          â”‚ æŸ¥è¯¢åˆ·æ–°
        â”‚                   â”‚
        â†“                   â”‚
   è¿‡æœŸ (Expired)           â”‚
        â”‚                   â”‚
        â”‚ cleanup_expired_keys()
        â†“
   åˆ é™¤ (Deleted)
        â”‚
        â†“
   [å·²æ¸…é™¤]


æ—¶é—´çº¿ç¤ºä¾‹ (TTL = 3600 ç§’):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 t=0        t=3600         t=7200
  â”‚           â”‚              â”‚
  â”‚  æ´»è·ƒæœŸ   â”‚   è¿‡æœŸæœŸ     â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚           â”‚              â”‚
åˆ›å»º         è¿‡æœŸ           æ¸…ç†
```

---

## ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Actrix System                            â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  å…¶ä»–æœåŠ¡         â”‚         â”‚   KS å®¢æˆ·ç«¯       â”‚            â”‚
â”‚  â”‚  (AIS, éªŒè¯æœåŠ¡)  â”‚  HTTP   â”‚   (Client)       â”‚            â”‚
â”‚  â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  HTTPS  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚                            â”‚                       â”‚
â”‚           â”‚ POST /ks/generate          â”‚                       â”‚
â”‚           â”‚ GET  /ks/secret/{id}       â”‚                       â”‚
â”‚           â”‚ GET  /ks/health            â”‚                       â”‚
â”‚           â†“                            â†“                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚           KS HTTP API (Axum Router)                 â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚      â”‚
â”‚  â”‚  â”‚  handlers.rs                               â”‚     â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ generate_key_handler()                  â”‚     â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ get_secret_key_handler()                â”‚     â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ health_check_handler()                  â”‚     â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚      â”‚
â”‚  â”‚                   â”‚                                 â”‚      â”‚
â”‚  â”‚                   â†“                                 â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚      â”‚
â”‚  â”‚  â”‚  KSState (æœåŠ¡çŠ¶æ€)                        â”‚     â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ storage: KeyStorage                     â”‚     â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ nonce_storage: SqliteNonceStorage       â”‚     â”‚      â”‚
â”‚  â”‚  â”‚  â€¢ psk: actrix_shared_key                   â”‚     â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                      â”‚                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚         â†“                         â†“                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  KeyStorage     â”‚    â”‚ SqliteNonceStorage  â”‚               â”‚
â”‚  â”‚  (storage.rs)   â”‚    â”‚ (nonce_storage.rs)  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚           â”‚                      â”‚                             â”‚
â”‚           â†“                      â†“                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚         SQLite Database                     â”‚               â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚               â”‚
â”‚  â”‚  â”‚  keys è¡¨     â”‚  â”‚  nonce è¡¨        â”‚    â”‚               â”‚
â”‚  â”‚  â”‚              â”‚  â”‚                  â”‚    â”‚               â”‚
â”‚  â”‚  â”‚ â€¢ key_id     â”‚  â”‚ â€¢ nonce          â”‚    â”‚               â”‚
â”‚  â”‚  â”‚ â€¢ public_key â”‚  â”‚ â€¢ timestamp      â”‚    â”‚               â”‚
â”‚  â”‚  â”‚ â€¢ secret_key â”‚  â”‚ â€¢ expiry_time    â”‚    â”‚               â”‚
â”‚  â”‚  â”‚ â€¢ created_at â”‚  â”‚                  â”‚    â”‚               â”‚
â”‚  â”‚  â”‚ â€¢ expires_at â”‚  â”‚                  â”‚    â”‚               â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚               â”‚
â”‚  â”‚                                             â”‚               â”‚
â”‚  â”‚  æ–‡ä»¶: /var/lib/actrix/ks.db               â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—ä¾èµ–å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           crates/ks/                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                â”‚
â”‚  lib.rs (å…¬å…±æ¥å£)                             â”‚
â”‚    â”‚                                           â”‚
â”‚    â”œâ”€â–º handlers.rs (HTTP å¤„ç†å™¨)              â”‚
â”‚    â”‚     â”œâ”€â–º KSState                          â”‚
â”‚    â”‚     â”œâ”€â–º generate_key_handler()           â”‚
â”‚    â”‚     â”œâ”€â–º get_secret_key_handler()         â”‚
â”‚    â”‚     â””â”€â–º health_check_handler()           â”‚
â”‚    â”‚                                           â”‚
â”‚    â”œâ”€â–º storage.rs (å­˜å‚¨å±‚)                     â”‚
â”‚    â”‚     â”œâ”€â–º KeyStorage                       â”‚
â”‚    â”‚     â”œâ”€â–º generate_and_store_key()         â”‚
â”‚    â”‚     â”œâ”€â–º get_secret_key()                 â”‚
â”‚    â”‚     â””â”€â–º cleanup_expired_keys()           â”‚
â”‚    â”‚                                           â”‚
â”‚    â”œâ”€â–º nonce_storage.rs (Nonce å­˜å‚¨)          â”‚
â”‚    â”‚     â””â”€â–º SqliteNonceStorage               â”‚
â”‚    â”‚                                           â”‚
â”‚    â”œâ”€â–º client.rs (KS å®¢æˆ·ç«¯)                  â”‚
â”‚    â”‚     â”œâ”€â–º Client                           â”‚
â”‚    â”‚     â””â”€â–º fetch_secret_key()               â”‚
â”‚    â”‚                                           â”‚
â”‚    â”œâ”€â–º types.rs (æ•°æ®ç±»å‹)                     â”‚
â”‚    â”‚     â”œâ”€â–º GenerateKeyRequest/Response      â”‚
â”‚    â”‚     â”œâ”€â–º GetSecretKeyRequest/Response     â”‚
â”‚    â”‚     â””â”€â–º KeyPair, KeyRecord               â”‚
â”‚    â”‚                                           â”‚
â”‚    â”œâ”€â–º config.rs (é…ç½®)                        â”‚
â”‚    â”‚     â””â”€â–º KeyServerConfig                  â”‚
â”‚    â”‚                                           â”‚
â”‚    â””â”€â–º error.rs (é”™è¯¯ç±»å‹)                     â”‚
â”‚          â””â”€â–º KsError                           â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤–éƒ¨ä¾èµ–:
  â€¢ ecies v0.2.9         â†’ æ¤­åœ†æ›²çº¿åŠ å¯†
  â€¢ rusqlite v0.35.0     â†’ SQLite æ•°æ®åº“
  â€¢ nonce-auth v0.6.1    â†’ Nonce è®¤è¯
  â€¢ axum v0.8.0          â†’ Web æ¡†æ¶
  â€¢ reqwest v0.12.0      â†’ HTTP å®¢æˆ·ç«¯
```

---

## å·¥ä½œæµç¨‹

### 1. å¯†é’¥ç”Ÿæˆæµç¨‹

```
å®¢æˆ·ç«¯è¯·æ±‚ç”Ÿæˆå¯†é’¥
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 1: æ„å»ºè¯·æ±‚                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  GenerateKeyRequest {                                   â”‚
â”‚      credential: NonceCredential {                      â”‚
â”‚          nonce: "uuid-v4",                              â”‚
â”‚          timestamp: 1730611200,                         â”‚
â”‚          signature: "hmac-sha256..."                    â”‚
â”‚      }                                                  â”‚
â”‚  }                                                      â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
         POST /ks/generate
                   â”‚
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 2: æœåŠ¡ç«¯éªŒè¯ (handlers.rs:106-129)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  2.1 éªŒè¯ Nonce (é˜²é‡æ”¾)                                â”‚
â”‚       â”œâ”€ æ£€æŸ¥ nonce æ˜¯å¦å·²ä½¿ç”¨                         â”‚
â”‚       â””â”€ æ£€æŸ¥ timestamp æ˜¯å¦åœ¨çª—å£å†… (Â±300ç§’)          â”‚
â”‚                                                         â”‚
â”‚  2.2 éªŒè¯ç­¾å                                           â”‚
â”‚       â”œâ”€ ä½¿ç”¨ PSK é‡æ–°è®¡ç®—ç­¾å                         â”‚
â”‚       â”œâ”€ æ¯”å¯¹ç­¾åæ˜¯å¦åŒ¹é…                              â”‚
â”‚       â””â”€ ç­¾å payload: "generate_key"                  â”‚
â”‚                                                         â”‚
â”‚  2.3 æ ‡è®° nonce ä¸ºå·²ä½¿ç”¨                                â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“ (éªŒè¯é€šè¿‡)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 3: ç”Ÿæˆå¯†é’¥å¯¹ (storage.rs:194-213)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  3.1 ç”Ÿæˆ ECIES å¯†é’¥å¯¹                                  â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚       â”‚ ecies::utils::generate_keypair()              â”‚
â”‚       â”‚   â†“                          â”‚                 â”‚
â”‚       â”‚ secret_key: [u8; 32]         â”‚                 â”‚
â”‚       â”‚ public_key: [u8; 33]         â”‚                 â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                         â”‚
â”‚  3.2 Base64 ç¼–ç                                         â”‚
â”‚       secret_key_b64 = BASE64(secret_key)              â”‚
â”‚       public_key_b64 = BASE64(public_key)              â”‚
â”‚                                                         â”‚
â”‚  3.3 å­˜å‚¨åˆ°æ•°æ®åº“                                       â”‚
â”‚       INSERT INTO keys VALUES (                        â”‚
â”‚           key_id: AUTOINCREMENT,                       â”‚
â”‚           public_key: public_key_b64,                  â”‚
â”‚           secret_key: secret_key_b64,                  â”‚
â”‚           created_at: now,                             â”‚
â”‚           expires_at: now + TTL                        â”‚
â”‚       )                                                â”‚
â”‚                                                         â”‚
â”‚  3.4 è·å–è‡ªåŠ¨ç”Ÿæˆçš„ key_id                             â”‚
â”‚       key_id = last_insert_rowid()                     â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 4: è¿”å›å“åº”                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  GenerateKeyResponse {                                  â”‚
â”‚      key_id: 123,                                       â”‚
â”‚      public_key: "BHxN7Q8vK...",  // Base64            â”‚
â”‚      expires_at: 1730614800       // Unix æ—¶é—´æˆ³       â”‚
â”‚  }                                                      â”‚
â”‚                                                         â”‚
â”‚  æ³¨æ„: ä¸è¿”å› secret_key!                              â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ—¶åºå›¾**:

```
å®¢æˆ·ç«¯           KS API          KeyStorage      SQLite
  â”‚                â”‚                 â”‚              â”‚
  â”‚  POST /generateâ”‚                 â”‚              â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚              â”‚
  â”‚                â”‚                 â”‚              â”‚
  â”‚                â”‚ verify_nonce()  â”‚              â”‚
  â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
  â”‚                â”‚      OK         â”‚              â”‚
  â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
  â”‚                â”‚                 â”‚              â”‚
  â”‚                â”‚ generate_key()  â”‚              â”‚
  â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
  â”‚                â”‚                 â”‚  INSERT      â”‚
  â”‚                â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                â”‚                 â”‚  key_id=123  â”‚
  â”‚                â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                â”‚   KeyPair       â”‚              â”‚
  â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
  â”‚                â”‚                 â”‚              â”‚
  â”‚   Response     â”‚                 â”‚              â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚              â”‚
  â”‚                â”‚                 â”‚              â”‚
```

### 2. å¯†é’¥æŸ¥è¯¢æµç¨‹

```
éªŒè¯æœåŠ¡è¯·æ±‚ç§é’¥
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 1: æ„å»ºè¯·æ±‚                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  GetSecretKeyRequest {                                  â”‚
â”‚      key_id: 123,                                       â”‚
â”‚      credential: NonceCredential {                      â”‚
â”‚          nonce: "uuid-v4",                              â”‚
â”‚          timestamp: 1730612000,                         â”‚
â”‚          signature: "hmac-sha256..."                    â”‚
â”‚      }                                                  â”‚
â”‚  }                                                      â”‚
â”‚                                                         â”‚
â”‚  ç­¾å payload: "get_secret_key:123"                     â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
     GET /ks/secret/123?credential={...}
                   â”‚
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 2: éªŒè¯è¯·æ±‚ (handlers.rs:132-168)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  2.1 éªŒè¯è·¯å¾„å‚æ•°å’ŒæŸ¥è¯¢å‚æ•°ä¸€è‡´                         â”‚
â”‚       if path_key_id != query_key_id:                  â”‚
â”‚           return 400 Bad Request                       â”‚
â”‚                                                         â”‚
â”‚  2.2 éªŒè¯ Nonce + ç­¾å                                  â”‚
â”‚       (åŒç”Ÿæˆæµç¨‹)                                      â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“ (éªŒè¯é€šè¿‡)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 3: æŸ¥è¯¢å¯†é’¥ (storage.rs:134-158)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  3.1 è§¦å‘æ¸…ç†æ£€æŸ¥                                       â”‚
â”‚       if now - last_cleanup > 3600:                    â”‚
â”‚           cleanup_expired_keys()                       â”‚
â”‚                                                         â”‚
â”‚  3.2 ä»æ•°æ®åº“æŸ¥è¯¢                                       â”‚
â”‚       SELECT secret_key FROM keys                      â”‚
â”‚       WHERE key_id = 123                               â”‚
â”‚                                                         â”‚
â”‚  3.3 æ£€æŸ¥ç»“æœ                                           â”‚
â”‚       â”Œâ”€ æ‰¾åˆ°å¯†é’¥ â†’ è¿”å› secret_key                    â”‚
â”‚       â””â”€ æœªæ‰¾åˆ°   â†’ è¿”å› 404 Not Found                 â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“ (æ‰¾åˆ°å¯†é’¥)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 4: è¿”å›å“åº”                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  GetSecretKeyResponse {                                 â”‚
â”‚      key_id: 123,                                       â”‚
â”‚      secret_key: "VxPz9m2...",  // Base64              â”‚
â”‚      expires_at: 1730614800                            â”‚
â”‚  }                                                      â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. å¯†é’¥è¿‡æœŸå’Œæ¸…ç†æµç¨‹

```
è‡ªåŠ¨æ¸…ç†æœºåˆ¶ (storage.rs:249-275)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§¦å‘æ¡ä»¶                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  1. æ¯æ¬¡ get_secret_key() è°ƒç”¨æ—¶       â”‚
â”‚  2. è·ç¦»ä¸Šæ¬¡æ¸…ç† >= 1 å°æ—¶ (3600ç§’)    â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¸…ç†è¿‡ç¨‹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  DELETE FROM keys                       â”‚
â”‚  WHERE expires_at > 0                   â”‚
â”‚    AND expires_at < now                 â”‚
â”‚                                         â”‚
â”‚  è¿”å›: åˆ é™¤çš„å¯†é’¥æ•°é‡                  â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ›´æ–°æ¸…ç†æ—¶é—´æˆ³                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  last_cleanup_time = now                â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


æ—¶é—´çº¿ç¤ºä¾‹:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
t=0       t=3600      t=7200      t=10800
 â”‚          â”‚           â”‚            â”‚
 â”‚          â”‚           â”‚            â”‚
 â”‚  å¯†é’¥1   â”‚   è¿‡æœŸ    â”‚   æ¸…ç†     â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚          â”‚           â”‚            â”‚
 â”‚          â”‚  å¯†é’¥2    â”‚   è¿‡æœŸ     â”‚   æ¸…ç†
 â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚â”€â”€â”€â”€â”€â”€â”€â”€>
 â”‚          â”‚           â”‚            â”‚
 â”‚          â”‚           â”‚  å¯†é’¥3     â”‚   è¿‡æœŸ
 â”‚          â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚â”€â”€â”€â”€â”€â”€â”€â”€>
 â”‚          â”‚           â”‚            â”‚

æ¸…ç†è§¦å‘ç‚¹:
  âœ“ æ¯å°æ—¶è§¦å‘ä¸€æ¬¡æ¸…ç†
  âœ“ åˆ é™¤æ‰€æœ‰å·²è¿‡æœŸçš„å¯†é’¥
  âœ“ TTL=0 çš„å¯†é’¥æ°¸ä¸è¿‡æœŸ
```

---

## API è¯¦è§£

### API ç«¯ç‚¹æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  KS API Endpoints                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  POST   /ks/generate                                   â”‚
â”‚         ç”Ÿæˆæ–°çš„å¯†é’¥å¯¹                                 â”‚
â”‚                                                        â”‚
â”‚  GET    /ks/secret/{key_id}                            â”‚
â”‚         è·å–æŒ‡å®šå¯†é’¥çš„ç§é’¥                             â”‚
â”‚                                                        â”‚
â”‚  GET    /ks/health                                     â”‚
â”‚         å¥åº·æ£€æŸ¥                                       â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰€æœ‰ API éƒ½æŒ‚è½½åœ¨ /ks è·¯ç”±å‰ç¼€ä¸‹
å®Œæ•´è·¯å¾„ç¤ºä¾‹: https://actrix.example.com/ks/generate
```

### 1. ç”Ÿæˆå¯†é’¥å¯¹ API

**ç«¯ç‚¹**: `POST /ks/generate`

**è¯·æ±‚**:
```http
POST /ks/generate HTTP/1.1
Host: actrix.example.com
Content-Type: application/json

{
  "credential": {
    "nonce": "550e8400-e29b-41d4-a716-446655440000",
    "timestamp": 1730611200,
    "signature": "qMZ8vL3xYH2k..."
  }
}
```

**è¯·æ±‚ç»“æ„**:
```rust
// æ–‡ä»¶: crates/ks/src/types.rs:18-22
pub struct GenerateKeyRequest {
    pub credential: NonceCredential,
}

// NonceCredential æ¥è‡ª nonce-auth åº“
pub struct NonceCredential {
    pub nonce: String,        // UUID v4
    pub timestamp: i64,       // Unix æ—¶é—´æˆ³
    pub signature: String,    // HMAC-SHA256 ç­¾å
}
```

**ç­¾åè®¡ç®—**:
```rust
// Payload å›ºå®šä¸º "generate_key"
let payload = "generate_key";
let signature = HMAC-SHA256(psk, nonce + timestamp + payload);
```

**å“åº” 200 OK**:
```json
{
  "key_id": 123,
  "public_key": "BHxN7Q8vK9m2...",
  "expires_at": 1730614800
}
```

**å“åº”ç»“æ„**:
```rust
// æ–‡ä»¶: crates/ks/src/types.rs:25-33
pub struct GenerateKeyResponse {
    pub key_id: u32,
    pub public_key: String,      // Base64 ç¼–ç 
    pub expires_at: u64,         // Unix æ—¶é—´æˆ³
}
```

**é”™è¯¯å“åº”**:

| çŠ¶æ€ç  | é”™è¯¯ | åŸå›  |
|--------|------|------|
| 400 | `Invalid request` | è¯·æ±‚æ ¼å¼é”™è¯¯ |
| 401 | `Invalid signature` | PSK é”™è¯¯æˆ–ç­¾åä¸åŒ¹é… |
| 403 | `Nonce already used` | é‡æ”¾æ”»å‡»æ£€æµ‹ |
| 403 | `Timestamp out of range` | æ—¶é—´æˆ³è¶…å‡ºçª—å£ |
| 500 | `Database error` | æ•°æ®åº“æ“ä½œå¤±è´¥ |

**curl ç¤ºä¾‹**:
```bash
# 1. ç”Ÿæˆç­¾å (ä¼ªä»£ç )
NONCE=$(uuidgen)
TIMESTAMP=$(date +%s)
PAYLOAD="generate_key"
SIGNATURE=$(echo -n "${NONCE}${TIMESTAMP}${PAYLOAD}" | \
            openssl dgst -sha256 -hmac "your-psk" -binary | base64)

# 2. å‘é€è¯·æ±‚
curl -X POST https://actrix.example.com/ks/generate \
  -H "Content-Type: application/json" \
  -d "{
    \"credential\": {
      \"nonce\": \"${NONCE}\",
      \"timestamp\": ${TIMESTAMP},
      \"signature\": \"${SIGNATURE}\"
    }
  }"
```

### 2. è·å–ç§é’¥ API

**ç«¯ç‚¹**: `GET /ks/secret/{key_id}`

**è¯·æ±‚**:
```http
GET /ks/secret/123?key_id=123&credential=%7B%22nonce%22%3A%22...%22%7D HTTP/1.1
Host: actrix.example.com
```

**URL å‚æ•°**:
- `{key_id}` (è·¯å¾„å‚æ•°): è¦æŸ¥è¯¢çš„å¯†é’¥ ID
- `key_id` (æŸ¥è¯¢å‚æ•°): å¿…é¡»ä¸è·¯å¾„å‚æ•°ç›¸åŒ
- `credential` (æŸ¥è¯¢å‚æ•°): URL ç¼–ç çš„ JSON å‡­è¯

**è¯·æ±‚ç»“æ„**:
```rust
// æ–‡ä»¶: crates/ks/src/types.rs:36-42
pub struct GetSecretKeyRequest {
    pub key_id: u32,
    pub credential: NonceCredential,
}
```

**ç­¾å Payload**:
```rust
// Payload åŒ…å« key_id
let payload = format!("get_secret_key:{}", key_id);
let signature = HMAC-SHA256(psk, nonce + timestamp + payload);
```

**å“åº” 200 OK**:
```json
{
  "key_id": 123,
  "secret_key": "VxPz9m2nLw8...",
  "expires_at": 1730614800
}
```

**å“åº”ç»“æ„**:
```rust
// æ–‡ä»¶: crates/ks/src/types.rs:45-53
pub struct GetSecretKeyResponse {
    pub key_id: u32,
    pub secret_key: String,      // Base64 ç¼–ç 
    pub expires_at: u64,
}
```

**é”™è¯¯å“åº”**:

| çŠ¶æ€ç  | é”™è¯¯ | åŸå›  |
|--------|------|------|
| 400 | `key_id mismatch` | è·¯å¾„å’ŒæŸ¥è¯¢å‚æ•°ä¸åŒ¹é… |
| 401 | `Invalid signature` | è®¤è¯å¤±è´¥ |
| 403 | `Nonce already used` | é‡æ”¾æ”»å‡» |
| 404 | `Key not found` | å¯†é’¥ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ |
| 500 | `Database error` | æ•°æ®åº“é”™è¯¯ |

**curl ç¤ºä¾‹**:
```bash
KEY_ID=123
NONCE=$(uuidgen)
TIMESTAMP=$(date +%s)
PAYLOAD="get_secret_key:${KEY_ID}"
SIGNATURE=$(echo -n "${NONCE}${TIMESTAMP}${PAYLOAD}" | \
            openssl dgst -sha256 -hmac "your-psk" -binary | base64)

CREDENTIAL=$(cat <<EOF | jq -c '.' | jq -sRr @uri
{
  "nonce": "${NONCE}",
  "timestamp": ${TIMESTAMP},
  "signature": "${SIGNATURE}"
}
EOF
)

curl "https://actrix.example.com/ks/secret/${KEY_ID}?key_id=${KEY_ID}&credential=${CREDENTIAL}"
```

### 3. å¥åº·æ£€æŸ¥ API

**ç«¯ç‚¹**: `GET /ks/health`

**è¯·æ±‚**:
```http
GET /ks/health HTTP/1.1
Host: actrix.example.com
```

**ç‰¹ç‚¹**:
- âŒ ä¸éœ€è¦è®¤è¯
- âœ… å¿«é€Ÿå“åº”
- âœ… åŒ…å«æœåŠ¡ç»Ÿè®¡ä¿¡æ¯

**å“åº” 200 OK**:
```json
{
  "status": "healthy",
  "service": "ks",
  "key_count": 42,
  "timestamp": 1730611200
}
```

**å­—æ®µè¯´æ˜**:
- `status`: æœåŠ¡çŠ¶æ€ (`healthy` / `unhealthy`)
- `service`: æœåŠ¡åç§° (`ks`)
- `key_count`: å½“å‰å­˜å‚¨çš„å¯†é’¥æ€»æ•°
- `timestamp`: å½“å‰æœåŠ¡å™¨æ—¶é—´æˆ³

**ä½¿ç”¨åœºæ™¯**:
```bash
# ç›‘æ§è„šæœ¬
while true; do
  STATUS=$(curl -s http://localhost:8443/ks/health | jq -r '.status')
  if [ "$STATUS" != "healthy" ]; then
    echo "KS service unhealthy!" | mail -s "Alert" admin@example.com
  fi
  sleep 60
done
```

---

## å®‰å…¨æœºåˆ¶

### 1. PSK (Pre-Shared Key) è®¤è¯

```
PSK è®¤è¯æ¶æ„
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é…ç½®æ–‡ä»¶ (config.toml)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  actrix_shared_key = "your-strong-key-here"      â”‚
â”‚                                                 â”‚
â”‚  âš ï¸  æ‰€æœ‰å†…éƒ¨æœåŠ¡å…±äº«æ­¤å¯†é’¥                     â”‚
â”‚  âš ï¸  å¿…é¡»åœ¨éƒ¨ç½²å‰æ›´æ”¹é»˜è®¤å€¼                     â”‚
â”‚  âš ï¸  å¯†é’¥é•¿åº¦å»ºè®® â‰¥ 32 å­—ç¬¦                     â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ åŠ è½½åˆ°å†…å­˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  KSState                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  pub psk: String                                â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“ ç”¨äºéªŒè¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CredentialVerifier::verify()                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  1. æå–è¯·æ±‚ä¸­çš„ signature                      â”‚
â”‚  2. ä½¿ç”¨ psk é‡æ–°è®¡ç®—ç­¾å                       â”‚
â”‚  3. æ¯”å¯¹ä¸¤ä¸ªç­¾åæ˜¯å¦ä¸€è‡´                        â”‚
â”‚                                                  â”‚
â”‚  è®¡ç®—å…¬å¼:                                       â”‚
â”‚  signature = HMAC-SHA256(psk, data)             â”‚
â”‚  data = nonce + timestamp + payload             â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä»£ç å®ç°**:
```rust
// æ–‡ä»¶: crates/ks/src/handlers.rs:35-57
pub async fn verify_credential(
    &self,
    credential: &nonce_auth::NonceCredential,
    request_payload: &str,
) -> Result<(), KsError> {
    let verify_result = CredentialVerifier::new(self.nonce_storage.clone())
        .with_secret(self.psk.as_bytes())  // â† PSK
        .verify(credential, request_payload.as_bytes())
        .await;

    // é”™è¯¯å¤„ç†...
}
```

### 2. Nonce é˜²é‡æ”¾æ”»å‡»

```
Nonce é˜²é‡æ”¾æœºåˆ¶å·¥ä½œåŸç†
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ä¸€æ¬¡è¯·æ±‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  1. å®¢æˆ·ç«¯ç”Ÿæˆå”¯ä¸€ nonce                       â”‚
â”‚     nonce = "550e8400-e29b-41d4-a716-..."      â”‚
â”‚                                                 â”‚
â”‚  2. æœåŠ¡å™¨æ£€æŸ¥ nonce æ˜¯å¦å­˜åœ¨                  â”‚
â”‚     SELECT * FROM nonce WHERE nonce = ?        â”‚
â”‚     ç»“æœ: ä¸å­˜åœ¨ âœ“                             â”‚
â”‚                                                 â”‚
â”‚  3. æœåŠ¡å™¨æ ‡è®° nonce ä¸ºå·²ä½¿ç”¨                  â”‚
â”‚     INSERT INTO nonce VALUES (nonce, ...)      â”‚
â”‚                                                 â”‚
â”‚  4. å¤„ç†è¯·æ±‚                                    â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é‡æ”¾æ”»å‡»å°è¯• (ä½¿ç”¨ç›¸åŒ nonce)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  1. æ”»å‡»è€…é‡æ”¾ç›¸åŒè¯·æ±‚                         â”‚
â”‚     nonce = "550e8400-e29b-41d4-a716-..."      â”‚
â”‚                                                 â”‚
â”‚  2. æœåŠ¡å™¨æ£€æŸ¥ nonce                            â”‚
â”‚     SELECT * FROM nonce WHERE nonce = ?        â”‚
â”‚     ç»“æœ: å·²å­˜åœ¨ âœ—                             â”‚
â”‚                                                 â”‚
â”‚  3. æ‹’ç»è¯·æ±‚                                    â”‚
â”‚     è¿”å› 403 Forbidden                         â”‚
â”‚     é”™è¯¯: "Nonce already used"                 â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Nonce è¡¨ç»“æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  nonce è¡¨                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  nonce        TEXT PRIMARY KEY           â”‚
â”‚  timestamp    INTEGER NOT NULL           â”‚
â”‚  expiry_time  INTEGER NOT NULL           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¸…ç†ç­–ç•¥:
  â€¢ å®šæœŸæ¸…ç†è¿‡æœŸ nonce (expiry_time < now)
  â€¢ é»˜è®¤æœ‰æ•ˆæœŸ: 300 ç§’ (5 åˆ†é’Ÿ)
```

**ä»£ç å®ç°**:
```rust
// æ–‡ä»¶: crates/ks/src/nonce_storage.rs
impl StorageBackend for SqliteNonceStorage {
    async fn store_nonce(&self, nonce: &str, timestamp: i64)
        -> Result<(), NonceError> {
        // å­˜å‚¨ nonce
    }

    async fn check_nonce(&self, nonce: &str)
        -> Result<bool, NonceError> {
        // æ£€æŸ¥ nonce æ˜¯å¦å·²å­˜åœ¨
    }

    async fn cleanup_expired(&self, before_timestamp: i64)
        -> Result<(), NonceError> {
        // æ¸…ç†è¿‡æœŸ nonce
    }
}
```

### 3. æ—¶é—´æˆ³éªŒè¯

```
æ—¶é—´çª—å£éªŒè¯
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å…è®¸çš„æ—¶é—´çª—å£: Â±300 ç§’ (5 åˆ†é’Ÿ)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    t-300        t-0         t+300
      â”‚           â”‚            â”‚
      â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
      â”‚   æœ‰æ•ˆçª—å£ â”‚            â”‚
      â”‚           â”‚            â”‚
      â”‚           â”‚            â”‚
   âœ— å¤ªæ—§       å½“å‰æ—¶é—´     âœ— å¤ªæ–°


ç¤ºä¾‹:
  å½“å‰æ—¶é—´: 1730611200

  âœ“ æœ‰æ•ˆè¯·æ±‚:
    timestamp = 1730610900  (now - 300)
    timestamp = 1730611200  (now)
    timestamp = 1730611500  (now + 300)

  âœ— æ— æ•ˆè¯·æ±‚:
    timestamp = 1730610800  (now - 400, å¤ªæ—§)
    timestamp = 1730611700  (now + 500, å¤ªæ–°)


æ‹’ç»åŸå› :
  â€¢ é˜²æ­¢é‡æ”¾è¿‡æœŸè¯·æ±‚
  â€¢ é˜²æ­¢æ—¶é’Ÿä¸åŒæ­¥æ”»å‡»
  â€¢ é™åˆ¶ nonce å­˜å‚¨æ—¶é—´
```

**å®ç°ç»†èŠ‚**:
```rust
// nonce-auth åº“å†…éƒ¨å®ç°
const TIME_WINDOW: i64 = 300;  // ç§’

fn validate_timestamp(request_ts: i64, server_ts: i64) -> bool {
    let diff = (request_ts - server_ts).abs();
    diff <= TIME_WINDOW
}
```

### 4. å®Œæ•´è®¤è¯æµç¨‹

```
å®Œæ•´è®¤è¯æµç¨‹å›¾
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å®¢æˆ·ç«¯                           KS æœåŠ¡å™¨
  â”‚                                  â”‚
  â”‚ 1. å‡†å¤‡è¯·æ±‚æ•°æ®                  â”‚
  â”‚    â€¢ nonce = UUID v4            â”‚
  â”‚    â€¢ timestamp = now()          â”‚
  â”‚    â€¢ payload = "generate_key"   â”‚
  â”‚                                  â”‚
  â”‚ 2. è®¡ç®—ç­¾å                      â”‚
  â”‚    data = nonce + ts + payload  â”‚
  â”‚    sig = HMAC-SHA256(psk, data) â”‚
  â”‚                                  â”‚
  â”‚ 3. æ„å»ºå‡­è¯                      â”‚
  â”‚    credential = {               â”‚
  â”‚      nonce, timestamp, sig      â”‚
  â”‚    }                             â”‚
  â”‚                                  â”‚
  â”‚ POST /ks/generate                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                                  â”‚
  â”‚                                  â”‚ 4. éªŒè¯æ—¶é—´æˆ³
  â”‚                                  â”‚    if |ts - now| > 300:
  â”‚                                  â”‚      return 403
  â”‚                                  â”‚
  â”‚                                  â”‚ 5. æ£€æŸ¥ nonce
  â”‚                                  â”‚    if nonce_exists:
  â”‚                                  â”‚      return 403
  â”‚                                  â”‚
  â”‚                                  â”‚ 6. éªŒè¯ç­¾å
  â”‚                                  â”‚    data = nonce + ts + payload
  â”‚                                  â”‚    sig' = HMAC(psk, data)
  â”‚                                  â”‚    if sig != sig':
  â”‚                                  â”‚      return 401
  â”‚                                  â”‚
  â”‚                                  â”‚ 7. æ ‡è®° nonce å·²ä½¿ç”¨
  â”‚                                  â”‚    INSERT INTO nonce...
  â”‚                                  â”‚
  â”‚                                  â”‚ 8. å¤„ç†ä¸šåŠ¡é€»è¾‘
  â”‚                                  â”‚    generate_key()
  â”‚                                  â”‚
  â”‚         Response                 â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                  â”‚
```

### 5. å®‰å…¨æœ€ä½³å®è·µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éƒ¨ç½²å‰å®‰å…¨æ£€æŸ¥æ¸…å•                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  âœ… æ›´æ”¹é»˜è®¤ PSK                                â”‚
â”‚     â€¢ é•¿åº¦ â‰¥ 32 å­—ç¬¦                           â”‚
â”‚     â€¢ ä½¿ç”¨å¼ºéšæœºç”Ÿæˆå™¨                         â”‚
â”‚     â€¢ å®šæœŸè½®è½¬ (å»ºè®®æ¯ 90 å¤©)                  â”‚
â”‚                                                 â”‚
â”‚  âœ… æ–‡ä»¶æƒé™                                    â”‚
â”‚     â€¢ config.toml: 600 (rw-------)             â”‚
â”‚     â€¢ *.db: 600                                â”‚
â”‚     â€¢ ç›®å½•: 700                                â”‚
â”‚                                                 â”‚
â”‚  âœ… ç½‘ç»œéš”ç¦»                                    â”‚
â”‚     â€¢ ä»…å†…ç½‘è®¿é—®                               â”‚
â”‚     â€¢ ä¸æš´éœ²åˆ°å…¬ç½‘                             â”‚
â”‚     â€¢ ä½¿ç”¨é˜²ç«å¢™è§„åˆ™                           â”‚
â”‚                                                 â”‚
â”‚  âœ… HTTPS/TLS                                   â”‚
â”‚     â€¢ ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ HTTPS                       â”‚
â”‚     â€¢ ä½¿ç”¨æœ‰æ•ˆè¯ä¹¦                             â”‚
â”‚     â€¢ TLS 1.2+                                 â”‚
â”‚                                                 â”‚
â”‚  âœ… æ—¥å¿—å’Œå®¡è®¡                                  â”‚
â”‚     â€¢ è®°å½•æ‰€æœ‰å¯†é’¥è®¿é—®                         â”‚
â”‚     â€¢ ç›‘æ§å¼‚å¸¸è¯·æ±‚                             â”‚
â”‚     â€¢ å®šæœŸå®¡æŸ¥æ—¥å¿—                             â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®å­˜å‚¨

### æ•°æ®åº“è¡¨ç»“æ„

```sql
-- å¯†é’¥è¡¨
CREATE TABLE keys (
    key_id INTEGER PRIMARY KEY AUTOINCREMENT,
    public_key TEXT NOT NULL,
    secret_key TEXT NOT NULL,
    created_at INTEGER NOT NULL,
    expires_at INTEGER NOT NULL
);

-- ç´¢å¼•
CREATE INDEX idx_keys_expires_at ON keys(expires_at);

-- Nonce è¡¨ (é˜²é‡æ”¾)
CREATE TABLE nonce (
    nonce TEXT PRIMARY KEY,
    timestamp INTEGER NOT NULL,
    expiry_time INTEGER NOT NULL
);
```

### å­—æ®µè¯´æ˜

**keys è¡¨**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `key_id` | INTEGER | è‡ªåŠ¨é€’å¢ä¸»é”® | 1, 2, 3... |
| `public_key` | TEXT | Base64 ç¼–ç çš„å…¬é’¥ | "BHxN7Q8vK..." |
| `secret_key` | TEXT | Base64 ç¼–ç çš„ç§é’¥ | "VxPz9m2nL..." |
| `created_at` | INTEGER | åˆ›å»ºæ—¶é—´ (Unix æ—¶é—´æˆ³) | 1730611200 |
| `expires_at` | INTEGER | è¿‡æœŸæ—¶é—´ (0=æ°¸ä¸è¿‡æœŸ) | 1730614800 |

**å­˜å‚¨æ ¼å¼**:
```
å…¬é’¥é•¿åº¦: 33 å­—èŠ‚ â†’ Base64 ç¼–ç å 44 å­—ç¬¦
ç§é’¥é•¿åº¦: 32 å­—èŠ‚ â†’ Base64 ç¼–ç å 44 å­—ç¬¦
```

### æ•°æ®å­˜å‚¨æµç¨‹

```
å†™å…¥æµç¨‹ (storage.rs:85-107)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç”Ÿæˆæ¤­åœ†æ›²çº¿å¯†é’¥å¯¹                     â”‚
â”‚     (secret_key, public_key)               â”‚
â”‚                                            â”‚
â”‚  2. Base64 ç¼–ç                             â”‚
â”‚     secret_key_b64 = BASE64(secret_key)    â”‚
â”‚     public_key_b64 = BASE64(public_key)    â”‚
â”‚                                            â”‚
â”‚  3. è®¡ç®—è¿‡æœŸæ—¶é—´                           â”‚
â”‚     if key_ttl_seconds == 0:              â”‚
â”‚         expires_at = 0  (æ°¸ä¸è¿‡æœŸ)        â”‚
â”‚     else:                                  â”‚
â”‚         expires_at = now + key_ttl_secondsâ”‚
â”‚                                            â”‚
â”‚  4. æ’å…¥æ•°æ®åº“                             â”‚
â”‚     INSERT INTO keys VALUES (             â”‚
â”‚         NULL,  -- key_id è‡ªåŠ¨ç”Ÿæˆ         â”‚
â”‚         public_key_b64,                    â”‚
â”‚         secret_key_b64,                    â”‚
â”‚         now,                               â”‚
â”‚         expires_at                         â”‚
â”‚     )                                      â”‚
â”‚                                            â”‚
â”‚  5. è·å–è‡ªåŠ¨ç”Ÿæˆçš„ key_id                  â”‚
â”‚     key_id = last_insert_rowid()          â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


è¯»å–æµç¨‹ (storage.rs:134-158)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. è§¦å‘æ¸…ç†æ£€æŸ¥                           â”‚
â”‚     maybe_cleanup()                        â”‚
â”‚                                            â”‚
â”‚  2. ä»æ•°æ®åº“æŸ¥è¯¢                           â”‚
â”‚     SELECT secret_key                      â”‚
â”‚     FROM keys                              â”‚
â”‚     WHERE key_id = ?                       â”‚
â”‚                                            â”‚
â”‚  3. æ£€æŸ¥ç»“æœ                               â”‚
â”‚     â€¢ æ‰¾åˆ° â†’ è¿”å› secret_key_b64          â”‚
â”‚     â€¢ æœªæ‰¾åˆ° â†’ è¿”å› None                  â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å­˜å‚¨ä¼˜åŒ–

```
ä¼˜åŒ–æªæ–½
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… ç´¢å¼•ä¼˜åŒ–
   CREATE INDEX idx_keys_expires_at ON keys(expires_at)

   ç”¨é€”:
   â€¢ åŠ é€Ÿè¿‡æœŸå¯†é’¥æŸ¥è¯¢
   â€¢ æå‡æ¸…ç†æ“ä½œæ€§èƒ½

âœ… è‡ªåŠ¨é€’å¢
   key_id INTEGER PRIMARY KEY AUTOINCREMENT

   ä¼˜ç‚¹:
   â€¢ æ— éœ€æ‰‹åŠ¨ç®¡ç† ID
   â€¢ é¿å… ID å†²çª
   â€¢ ä¿è¯å…¨å±€å”¯ä¸€

âœ… å®šæœŸæ¸…ç†
   æ¯å°æ—¶è§¦å‘ä¸€æ¬¡æ¸…ç†

   DELETE FROM keys
   WHERE expires_at > 0 AND expires_at < now

   æ•ˆæœ:
   â€¢ æ§åˆ¶æ•°æ®åº“å¤§å°
   â€¢ æå‡æŸ¥è¯¢æ€§èƒ½
   â€¢ é‡Šæ”¾å­˜å‚¨ç©ºé—´

âš ï¸  å®‰å…¨è€ƒè™‘
   ç§é’¥å­˜å‚¨: Base64 ç¼–ç  (æœªåŠ å¯†)

   ç¼“è§£æªæ–½:
   â€¢ æ–‡ä»¶æƒé™ 600
   â€¢ ä»…å†…ç½‘è®¿é—®
   â€¢ å®šæœŸå®¡è®¡

   æœªæ¥æ”¹è¿›:
   â€¢ ä½¿ç”¨æ“ä½œç³»ç»Ÿå¯†é’¥ç¯
   â€¢ é›†æˆ KMS (Key Management Service)
   â€¢ å®ç°å¯†é’¥åˆ†ç‰‡å­˜å‚¨
```

### æ•°æ®åº“æ–‡ä»¶ä½ç½®

```
é»˜è®¤ä½ç½®:
  /var/lib/actrix/ks.db

é…ç½®æ–¹å¼:
  [ks]
  database_path = "/var/lib/actrix/ks.db"

æŸ¥çœ‹æ•°æ®åº“ä¿¡æ¯:
  sqlite3 /var/lib/actrix/ks.db "
    SELECT
      COUNT(*) as total_keys,
      SUM(CASE WHEN expires_at = 0 THEN 1 ELSE 0 END) as permanent_keys,
      SUM(CASE WHEN expires_at > 0 AND expires_at > strftime('%s', 'now')
               THEN 1 ELSE 0 END) as active_keys,
      SUM(CASE WHEN expires_at > 0 AND expires_at < strftime('%s', 'now')
               THEN 1 ELSE 0 END) as expired_keys
    FROM keys;
  "
```

---

## å®¢æˆ·ç«¯é›†æˆ

### 1. Rust å®¢æˆ·ç«¯

**åˆ›å»ºå®¢æˆ·ç«¯**:
```rust
use ks::{Client, ClientConfig};

let config = ClientConfig {
    endpoint: "https://ks.example.com".to_string(),
    psk: actrix_shared_key,  // ä»å…¨å±€é…ç½®è·å–
    timeout_seconds: 30,
    cache_db_path: None,
};

let client = Client::new(&config);
```

**è·å–ç§é’¥**:
```rust
// æ–‡ä»¶: crates/ks/src/client.rs:67-118
use ecies::SecretKey;

let key_id = 123;
let (secret_key, expires_at) = client.fetch_secret_key(key_id).await?;

// secret_key æ˜¯ ecies::SecretKey ç±»å‹ï¼Œå¯ç›´æ¥ç”¨äºè§£å¯†
// expires_at æ˜¯ Unix æ—¶é—´æˆ³
```

**å®Œæ•´ç¤ºä¾‹**:
```rust
use ks::{Client, ClientConfig};
use ecies::decrypt;

#[tokio::main]
async fn main() -> anyhow::Result<()> {
    // 1. åˆ›å»ºå®¢æˆ·ç«¯
    let client = Client::new(&ClientConfig {
        endpoint: "https://ks.example.com".to_string(),
        psk: "your-actrix-shared-key".to_string(),
        timeout_seconds: 30,
        cache_db_path: None,
    });

    // 2. è·å–ç§é’¥
    let key_id = 123;
    let (secret_key, expires_at) = client.fetch_secret_key(key_id).await?;

    println!("Got secret key, expires at: {}", expires_at);

    // 3. ä½¿ç”¨ç§é’¥è§£å¯†
    let encrypted_data = vec![/* ... */];
    let decrypted = decrypt(
        &secret_key.serialize(),
        &encrypted_data
    )?;

    println!("Decrypted: {:?}", decrypted);

    Ok(())
}
```

### 2. HTTP å®¢æˆ·ç«¯ (ä»»æ„è¯­è¨€)

**Python ç¤ºä¾‹**:
```python
import requests
import hmac
import hashlib
import base64
import time
import uuid
import json

class KSClient:
    def __init__(self, endpoint: str, psk: str):
        self.endpoint = endpoint
        self.psk = psk.encode('utf-8')

    def _create_credential(self, payload: str) -> dict:
        """åˆ›å»ºè®¤è¯å‡­è¯"""
        nonce = str(uuid.uuid4())
        timestamp = int(time.time())

        # è®¡ç®—ç­¾å
        data = f"{nonce}{timestamp}{payload}".encode('utf-8')
        signature = base64.b64encode(
            hmac.new(self.psk, data, hashlib.sha256).digest()
        ).decode('utf-8')

        return {
            "nonce": nonce,
            "timestamp": timestamp,
            "signature": signature
        }

    def generate_key(self) -> dict:
        """ç”Ÿæˆæ–°å¯†é’¥å¯¹"""
        url = f"{self.endpoint}/generate"
        credential = self._create_credential("generate_key")

        response = requests.post(url, json={
            "credential": credential
        })
        response.raise_for_status()
        return response.json()

    def get_secret_key(self, key_id: int) -> dict:
        """è·å–ç§é’¥"""
        url = f"{self.endpoint}/secret/{key_id}"
        payload = f"get_secret_key:{key_id}"
        credential = self._create_credential(payload)

        params = {
            "key_id": key_id,
            "credential": json.dumps(credential)
        }

        response = requests.get(url, params=params)
        response.raise_for_status()
        return response.json()

# ä½¿ç”¨ç¤ºä¾‹
client = KSClient("https://ks.example.com/ks", "your-psk")

# ç”Ÿæˆå¯†é’¥
result = client.generate_key()
print(f"Generated key_id: {result['key_id']}")

# è·å–ç§é’¥
secret = client.get_secret_key(result['key_id'])
print(f"Secret key: {secret['secret_key']}")
```

**JavaScript/Node.js ç¤ºä¾‹**:
```javascript
const crypto = require('crypto');
const axios = require('axios');
const { v4: uuidv4 } = require('uuid');

class KSClient {
    constructor(endpoint, psk) {
        this.endpoint = endpoint;
        this.psk = psk;
    }

    createCredential(payload) {
        const nonce = uuidv4();
        const timestamp = Math.floor(Date.now() / 1000);

        // è®¡ç®—ç­¾å
        const data = `${nonce}${timestamp}${payload}`;
        const signature = crypto
            .createHmac('sha256', this.psk)
            .update(data)
            .digest('base64');

        return { nonce, timestamp, signature };
    }

    async generateKey() {
        const url = `${this.endpoint}/generate`;
        const credential = this.createCredential('generate_key');

        const response = await axios.post(url, { credential });
        return response.data;
    }

    async getSecretKey(keyId) {
        const url = `${this.endpoint}/secret/${keyId}`;
        const payload = `get_secret_key:${keyId}`;
        const credential = this.createCredential(payload);

        const response = await axios.get(url, {
            params: {
                key_id: keyId,
                credential: JSON.stringify(credential)
            }
        });
        return response.data;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
(async () => {
    const client = new KSClient('https://ks.example.com/ks', 'your-psk');

    // ç”Ÿæˆå¯†é’¥
    const result = await client.generateKey();
    console.log(`Generated key_id: ${result.key_id}`);

    // è·å–ç§é’¥
    const secret = await client.getSecretKey(result.key_id);
    console.log(`Secret key: ${secret.secret_key}`);
})();
```

---

## è¿ç»´æŒ‡å—

### 1. éƒ¨ç½²é…ç½®

**é…ç½®æ–‡ä»¶** (`config.toml`):
```toml
# å¯ç”¨ KS æœåŠ¡
enable = 16  # æˆ–åŒ…å« 16 çš„ç»„åˆï¼Œå¦‚ 22 (KS + STUN + TURN)

# KS æœåŠ¡é…ç½®
[ks]
ip = "127.0.0.1"              # ç›‘å¬åœ°å€ (å»ºè®®ä»…å†…ç½‘)
port = 8081                   # ç›‘å¬ç«¯å£
database_path = "/var/lib/actrix/ks.db"
nonce_db_path = "/var/lib/actrix/nonce.db"
key_ttl_seconds = 3600        # å¯†é’¥ TTL (ç§’), 0=æ°¸ä¸è¿‡æœŸ

# å…¨å±€é…ç½®
actrix_shared_key = "your-strong-key-change-me"  # âš ï¸ å¿…é¡»æ›´æ”¹!
sqlite = "/var/lib/actrix/actrix.db"

# æ—¥å¿—é…ç½®
log_level = "info"
log_output = "file"
log_path = "/var/log/actrix"
```

### 2. å¯åŠ¨å’Œåœæ­¢

**systemd æœåŠ¡**:
```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl start actrix

# åœæ­¢æœåŠ¡
sudo systemctl stop actrix

# é‡å¯æœåŠ¡
sudo systemctl restart actrix

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status actrix

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u actrix -f
```

**æ‰‹åŠ¨å¯åŠ¨**:
```bash
# å¼€å‘æ¨¡å¼
cargo run -- --config config.toml

# ç”Ÿäº§æ¨¡å¼
./actrix --config /etc/actrix/config.toml
```

### 3. ç›‘æ§å’Œå¥åº·æ£€æŸ¥

**å¥åº·æ£€æŸ¥è„šæœ¬**:
```bash
#!/bin/bash
# check_ks_health.sh

ENDPOINT="http://localhost:8443/ks/health"
ALERT_EMAIL="admin@example.com"

# æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
RESPONSE=$(curl -s "$ENDPOINT")
STATUS=$(echo "$RESPONSE" | jq -r '.status')

if [ "$STATUS" != "healthy" ]; then
    echo "KS service unhealthy: $RESPONSE" | \
        mail -s "KS Alert" "$ALERT_EMAIL"
    exit 1
fi

# æ£€æŸ¥å¯†é’¥æ•°é‡
KEY_COUNT=$(echo "$RESPONSE" | jq -r '.key_count')
echo "KS is healthy, key_count: $KEY_COUNT"

# å¯é€‰: ç›‘æ§å¯†é’¥æ•°é‡å¢é•¿
# å¦‚æœå¯†é’¥æ•°è¿‡å¤šï¼Œå¯èƒ½éœ€è¦æ¸…ç†
if [ "$KEY_COUNT" -gt 10000 ]; then
    echo "Warning: Too many keys ($KEY_COUNT)" | \
        mail -s "KS Warning" "$ALERT_EMAIL"
fi

exit 0
```

**cron å®šæ—¶æ£€æŸ¥**:
```bash
# æ¯ 5 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
*/5 * * * * /usr/local/bin/check_ks_health.sh
```

### 4. æ•°æ®åº“ç»´æŠ¤

**æŸ¥çœ‹å¯†é’¥ç»Ÿè®¡**:
```bash
sqlite3 /var/lib/actrix/ks.db <<EOF
.mode column
.headers on

SELECT
    COUNT(*) as total_keys,
    SUM(CASE WHEN expires_at = 0 THEN 1 ELSE 0 END) as permanent,
    SUM(CASE WHEN expires_at > 0 THEN 1 ELSE 0 END) as with_ttl
FROM keys;

SELECT
    MIN(created_at) as oldest_key,
    MAX(created_at) as newest_key,
    COUNT(*) as total
FROM keys;
EOF
```

**æ‰‹åŠ¨æ¸…ç†è¿‡æœŸå¯†é’¥**:
```bash
sqlite3 /var/lib/actrix/ks.db <<EOF
-- æŸ¥çœ‹è¿‡æœŸå¯†é’¥
SELECT COUNT(*) FROM keys
WHERE expires_at > 0 AND expires_at < strftime('%s', 'now');

-- åˆ é™¤è¿‡æœŸå¯†é’¥
DELETE FROM keys
WHERE expires_at > 0 AND expires_at < strftime('%s', 'now');

-- å‹ç¼©æ•°æ®åº“
VACUUM;
EOF
```

**å¤‡ä»½æ•°æ®åº“**:
```bash
#!/bin/bash
# backup_ks_db.sh

BACKUP_DIR="/backup/actrix"
DB_PATH="/var/lib/actrix/ks.db"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/ks_${DATE}.db"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR"

# åœ¨çº¿å¤‡ä»½ (ä¸é”è¡¨)
sqlite3 "$DB_PATH" ".backup $BACKUP_FILE"

# å‹ç¼©å¤‡ä»½
gzip "$BACKUP_FILE"

# åˆ é™¤ 7 å¤©å‰çš„å¤‡ä»½
find "$BACKUP_DIR" -name "ks_*.db.gz" -mtime +7 -delete

echo "Backup completed: ${BACKUP_FILE}.gz"
```

### 5. æ€§èƒ½ä¼˜åŒ–

**æ•°æ®åº“ä¼˜åŒ–**:
```sql
-- åˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE keys;

-- é‡å»ºç´¢å¼•
REINDEX idx_keys_expires_at;

-- å‹ç¼©æ•°æ®åº“ (å›æ”¶ç©ºé—´)
VACUUM;
```

**ç³»ç»Ÿé…ç½®**:
```bash
# å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
ulimit -n 65536

# è°ƒæ•´ SQLite å‚æ•°
export SQLITE_TMPDIR=/tmp
```

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. è®¤è¯å¤±è´¥ (401 Unauthorized)

**ç—‡çŠ¶**:
```json
{
  "error": "Invalid signature"
}
```

**å¯èƒ½åŸå› **:
1. PSK ä¸åŒ¹é…
2. ç­¾åè®¡ç®—é”™è¯¯
3. Payload æ„é€ é”™è¯¯

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„ PSK
grep actrix_shared_key /etc/actrix/config.toml

# 2. æ£€æŸ¥å®¢æˆ·ç«¯ä½¿ç”¨çš„ PSK
# ç¡®ä¿å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä½¿ç”¨ç›¸åŒçš„å¯†é’¥

# 3. å¯ç”¨ debug æ—¥å¿—æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
RUST_LOG=debug ./actrix --config config.toml

# 4. éªŒè¯ç­¾åè®¡ç®—
# ç¡®ä¿ payload æ ¼å¼æ­£ç¡®:
#   ç”Ÿæˆå¯†é’¥: "generate_key"
#   è·å–ç§é’¥: "get_secret_key:<key_id>"
```

#### 2. é‡æ”¾æ”»å‡»æ£€æµ‹ (403 Forbidden)

**ç—‡çŠ¶**:
```json
{
  "error": "Nonce already used"
}
```

**å¯èƒ½åŸå› **:
1. å®¢æˆ·ç«¯é‡ç”¨äº† nonce
2. è¯·æ±‚è¢«é‡æ”¾
3. Nonce æ•°æ®åº“æŸå

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. ç¡®ä¿æ¯æ¬¡è¯·æ±‚ç”Ÿæˆæ–°çš„ nonce
# nonce å¿…é¡»æ˜¯å…¨å±€å”¯ä¸€çš„ UUID

# 2. æ£€æŸ¥ç³»ç»Ÿæ—¶é—´åŒæ­¥
ntpdate -q pool.ntp.org

# 3. æ¸…ç† nonce æ•°æ®åº“ (è°¨æ…æ“ä½œ)
sqlite3 /var/lib/actrix/nonce.db "DELETE FROM nonce;"
```

#### 3. å¯†é’¥ä¸å­˜åœ¨ (404 Not Found)

**ç—‡çŠ¶**:
```json
{
  "error": "Key not found: 123"
}
```

**å¯èƒ½åŸå› **:
1. key_id ä¸å­˜åœ¨
2. å¯†é’¥å·²è¿‡æœŸè¢«æ¸…ç†
3. æ•°æ®åº“æŸå

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æŸ¥è¯¢å¯†é’¥æ˜¯å¦å­˜åœ¨
sqlite3 /var/lib/actrix/ks.db \
  "SELECT * FROM keys WHERE key_id = 123;"

# 2. æ£€æŸ¥å¯†é’¥æ˜¯å¦è¿‡æœŸ
sqlite3 /var/lib/actrix/ks.db \
  "SELECT key_id, expires_at,
          strftime('%s', 'now') as now,
          CASE
            WHEN expires_at = 0 THEN 'never'
            WHEN expires_at > strftime('%s', 'now') THEN 'active'
            ELSE 'expired'
          END as status
   FROM keys WHERE key_id = 123;"

# 3. æŸ¥çœ‹æ‰€æœ‰å¯†é’¥
sqlite3 /var/lib/actrix/ks.db \
  "SELECT key_id, created_at, expires_at FROM keys ORDER BY key_id;"
```

#### 4. æ•°æ®åº“é”å®š (500 Internal Server Error)

**ç—‡çŠ¶**:
```json
{
  "error": "Database error: database is locked"
}
```

**å¯èƒ½åŸå› **:
1. å¤šä¸ªè¿›ç¨‹åŒæ—¶è®¿é—®
2. é•¿æ—¶é—´äº‹åŠ¡æœªæäº¤
3. ç£ç›˜ I/O æ€§èƒ½é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. ç¡®ä¿åªæœ‰ä¸€ä¸ª actrix å®ä¾‹è¿è¡Œ
ps aux | grep actrix
killall -9 actrix  # å¦‚æœæœ‰å¤šä¸ªå®ä¾‹

# 2. æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™
ls -l /var/lib/actrix/*.db

# 3. ä¿®å¤æ•°æ®åº“ (å¦‚æœæŸå)
sqlite3 /var/lib/actrix/ks.db "PRAGMA integrity_check;"

# 4. å¤‡ä»½å¹¶é‡å»ºæ•°æ®åº“
cp /var/lib/actrix/ks.db /backup/ks.db.backup
sqlite3 /var/lib/actrix/ks.db "VACUUM;"
```

### æ—¥å¿—åˆ†æ

**æŸ¥çœ‹ KS ç›¸å…³æ—¥å¿—**:
```bash
# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯
journalctl -u actrix | grep -i error | tail -20

# æŸ¥çœ‹ KS å¯†é’¥ç”Ÿæˆæ—¥å¿—
journalctl -u actrix | grep "Generated key pair"

# æŸ¥çœ‹è®¤è¯å¤±è´¥æ—¥å¿—
journalctl -u actrix | grep "Authentication error"

# å®æ—¶ç›‘æ§
journalctl -u actrix -f | grep -E "KS|key_id"
```

### æ€§èƒ½é—®é¢˜

#### å¯†é’¥æŸ¥è¯¢æ…¢

**è¯Šæ–­**:
```bash
# æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
sqlite3 /var/lib/actrix/ks.db <<EOF
EXPLAIN QUERY PLAN
SELECT secret_key FROM keys WHERE key_id = 123;
EOF

# åº”è¯¥çœ‹åˆ°: SEARCH TABLE keys USING INTEGER PRIMARY KEY
```

**ä¼˜åŒ–**:
```sql
-- é‡å»ºç´¢å¼•
REINDEX;

-- åˆ†æè¡¨
ANALYZE;

-- å‹ç¼©æ•°æ®åº“
VACUUM;
```

#### æ¸…ç†æ“ä½œæ…¢

**åŸå› **: è¿‡æœŸå¯†é’¥å¤ªå¤š

**è§£å†³**:
```bash
# è°ƒæ•´ TTL é…ç½®
# å‡å° key_ttl_secondsï¼Œé¿å…ç§¯ç´¯è¿‡å¤šå¯†é’¥

# æ‰‹åŠ¨è§¦å‘æ¸…ç†
sqlite3 /var/lib/actrix/ks.db \
  "DELETE FROM keys WHERE expires_at > 0 AND expires_at < strftime('%s', 'now');"
```

---

## é™„å½•

### A. é…ç½®å‚æ•°å®Œæ•´åˆ—è¡¨

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `ks.ip` | String | "127.0.0.1" | ç›‘å¬åœ°å€ |
| `ks.port` | u16 | 8081 | ç›‘å¬ç«¯å£ |
| `ks.database_path` | String | "ks.db" | å¯†é’¥æ•°æ®åº“è·¯å¾„ |
| `ks.nonce_db_path` | String | None | Nonce æ•°æ®åº“è·¯å¾„ |
| `ks.key_ttl_seconds` | u64 | 3600 | å¯†é’¥ TTL (0=æ°¸ä¸è¿‡æœŸ) |
| `actrix_shared_key` | String | - | PSK (å¿…é¡»é…ç½®) |

### B. é”™è¯¯ä»£ç å‚è€ƒ

| é”™è¯¯ä»£ç  | HTTP çŠ¶æ€ | è¯´æ˜ |
|----------|----------|------|
| `InvalidRequest` | 400 | è¯·æ±‚æ ¼å¼é”™è¯¯ |
| `Authentication` | 401 | ç­¾åéªŒè¯å¤±è´¥ |
| `ReplayAttack` | 403 | Nonce å·²ä½¿ç”¨ |
| `KeyNotFound` | 404 | å¯†é’¥ä¸å­˜åœ¨ |
| `Database` | 500 | æ•°æ®åº“é”™è¯¯ |
| `Internal` | 500 | å†…éƒ¨é”™è¯¯ |

### C. ç›¸å…³æ–‡æ¡£

- [CRATES.md](./CRATES.md) - KS å®ç°ç»†èŠ‚
- [API.md](./API.md) - KS API å‚è€ƒ
- [CONFIGURATION.md](./CONFIGURATION.md) - é…ç½®æŒ‡å—
- [SERVICES.md](./SERVICES.md) - æœåŠ¡éƒ¨ç½²

### D. æ–‡ä»¶ä½ç½®ç´¢å¼•

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|------|---------|------|
| åº“å…¥å£ | `crates/ks/src/lib.rs` | å…¬å…±æ¥å£ |
| HTTP å¤„ç†å™¨ | `crates/ks/src/handlers.rs` | API å®ç° |
| å­˜å‚¨å±‚ | `crates/ks/src/storage.rs` | æ•°æ®åº“æ“ä½œ |
| å®¢æˆ·ç«¯ | `crates/ks/src/client.rs` | Rust å®¢æˆ·ç«¯ |
| æ•°æ®ç±»å‹ | `crates/ks/src/types.rs` | è¯·æ±‚/å“åº”ç±»å‹ |
| é”™è¯¯å®šä¹‰ | `crates/ks/src/error.rs` | é”™è¯¯ç±»å‹ |
| é…ç½® | `crates/ks/src/config.rs` | é…ç½®ç»“æ„ |
| Nonce å­˜å‚¨ | `crates/ks/src/nonce_storage.rs` | é˜²é‡æ”¾å®ç° |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-03
**ç»´æŠ¤è€…**: Actrix Team
**åé¦ˆ**: https://github.com/actor-rtc/actrix/issues
